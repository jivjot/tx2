CREATE OR REPLACE FUNCTION User_Edit(
UserEmail varchar,
UserPassword varchar,
UserBirthDate date,
UserFirstName varchar,
UserMiddleName varchar,
UserLastName varchar,
UserEntity_id INTEGER,
UserGender character varying(1),
by_user INTEGER,
ip VARCHAR,
logdesc VARCHAR,
logprevstate VARCHAR,
OUT result INTEGER,
OUT rescode INTEGER
)
RETURNS RECORD AS $$
DECLARE 
    recid INTEGER;
    varrec RECORD;
    temp INTEGER;
BEGIN 

IF NOT EXISTS ( SELECT id FROM "Users_user" WHERE "UserEmail"=UserEmail) THEN
	result := -1;
	rescode := 2021;
	RETURN;
END IF;
SELECT id INTO recid FROM "Users_user" WHERE "UserEmail"=UserEmail;


SELECT * INTO varrec FROM checkuserforpermission(by_user,'UPDATE','txUser','user');
IF varrec.status <> 500 THEN
	result := -2;
	rescode := varrec.rescode;
	RETURN;
END IF;

UPDATE "Users_user"
   SET "UserPassword"=UserPassword,
       "UserBirthDate"=UserBirthDate, 
       "UserFirstName"=UserFirstName, 
       "UserMiddleName"=UserMiddleName, 
       "UserLastName"=UserLastName, 
       "UserEntity_id"=UserEntity_id, 
       "UserGender"=UserGender
 WHERE "UserEmail"=UserEmail;
GET DIAGNOSTICS temp := ROW_COUNT;
IF temp <> 1 THEN 
	result := -1;
	rescode := 2022;
        RETURN;
END IF;


INSERT INTO "Users_userlogs"("LogsUser_id","LogsPermission_id","LogsObject","LogsTimeStamp","LogsIP","LogsDescription","LogsPreviousState") 
						VALUES(by_user,varrec.varpci,recid,now(),ip,logdesc,logprevstate);
GET DIAGNOSTICS temp := ROW_COUNT;
IF temp <> 1 THEN 
	result := -1;
	rescode := 2023;
        RETURN;
ELSE
	result := 1;
	rescode := 2025;
END IF;
RETURN;



END;
$$ LANGUAGE plpgsql;

